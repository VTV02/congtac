<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng t√°c - THACO AGRI</title>
  
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <!-- SheetJS for Excel export -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary-color: #00682B;
      --primary-dark: #004d1f;
      --secondary-color: #FFFBD5;
      --text-dark: #333;
      --text-light: #666;
      --border-color: #ddd;
      --success-color: #00682B;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --info-color: #2196f3;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #FFFBD5 0%, #00682B 100%);
      background-attachment: fixed;
      min-height: 100vh;
      padding: 20px;
      animation: gradientShift 15s ease infinite;
    }
    
    @keyframes gradientShift {
      0%, 100% { background: linear-gradient(135deg, #FFFBD5 0%, #00682B 100%); }
      50% { background: linear-gradient(135deg, #00682B 0%, #FFFBD5 100%); }
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    /* Header */
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 30px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
      backdrop-filter: blur(10px);
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
      animation: headerGlow 8s ease-in-out infinite;
    }
    
    @keyframes headerGlow {
      0%, 100% { transform: translate(0, 0); }
      50% { transform: translate(-20px, -20px); }
    }
    
    .header h1 {
      font-size: 28px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .logo {
      width: 60px;
      height: 60px;
      background: white;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      overflow: hidden;
      position: relative;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.3s ease;
      animation: logoFloat 3s ease-in-out infinite;
    }
    
    @keyframes logoFloat {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-5px); }
    }
    
    .logo:hover {
      transform: scale(1.1) rotate(5deg);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .logo img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      padding: 5px;
    }
    
    .logo-upload-btn {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 104, 43, 0.9);
      color: white;
      font-size: 10px;
      padding: 3px;
      text-align: center;
      opacity: 0;
      transition: opacity 0.3s;
      cursor: pointer;
    }
    
    .logo:hover .logo-upload-btn {
      opacity: 1;
    }
    
    #logoInput {
      display: none;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      background: white;
      color: var(--primary-color);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: white;
      padding: 25px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color), var(--info-color));
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 12px 40px rgba(0,168,107,0.2);
    }
    
    .stat-card:hover::before {
      transform: scaleX(1);
    }
    
    .stat-card h3 {
      color: var(--text-light);
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 10px;
    }
    
    .stat-card .number {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
      animation: countUp 1s ease-out;
    }
    
    @keyframes countUp {
      from { 
        opacity: 0;
        transform: translateY(20px);
      }
      to { 
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .stat-card .icon {
      opacity: 0.2;
      float: right;
      transition: all 0.3s ease;
    }
    
    .stat-card:hover .icon {
      opacity: 0.4;
      transform: scale(1.1);
    }
    
    .stat-card .icon svg {
      display: block;
    }
    
    /* Charts Section */
    .charts-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .chart-card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .chart-card h3 {
      color: var(--text-dark);
      margin-bottom: 20px;
      font-size: 18px;
    }
    
    /* Form Section */
    .form-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    
    .form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      cursor: pointer;
      user-select: none;
    }
    
    .form-header h2 {
      color: var(--primary-color);
      font-size: 22px;
    }
    
    .toggle-icon {
      font-size: 24px;
      transition: transform 0.3s;
    }
    
    .toggle-icon.rotated {
      transform: rotate(180deg);
    }
    
    .form-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    
    .form-content.expanded {
      max-height: 1000px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      color: var(--text-dark);
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      padding: 12px;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-top: 10px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      justify-content: flex-end;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      display: inline-flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .btn::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 0;
      height: 0;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.3);
      transform: translate(-50%, -50%);
      transition: width 0.6s, height 0.6s;
    }
    
    .btn:hover::before {
      width: 300px;
      height: 300px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(0, 168, 107, 0.2);
    }
    
    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,168,107,0.4);
    }
    
    .btn-primary:active {
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #545b62;
    }
    
    .btn-success {
      background: var(--success-color);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger-color);
      color: white;
    }
    
    .btn-info {
      background: var(--info-color);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning-color);
      color: white;
    }
    
    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
    }
    
    /* Table Section */
    .table-section {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin: 20px 0;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .table-header h2 {
      color: var(--primary-color);
      font-size: 22px;
    }
    
    .table-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    /* Filters */
    .filters {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      padding: 20px;
      background: var(--secondary-color);
      border-radius: 8px;
    }
    
    .filter-item {
      flex: 1;
      min-width: 200px;
    }
    
    .filter-item input,
    .filter-item select {
      width: 100%;
      padding: 10px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
      font-size: 14px;
    }
    
    /* Table */
    .table-wrapper {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
    }
    
    thead {
      background: var(--primary-color);
      color: white;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    
    th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
    }
    
    td {
      padding: 12px 15px;
      border-bottom: 1px solid var(--border-color);
      font-size: 14px;
    }
    
    tbody tr {
      transition: all 0.3s ease;
      animation: slideIn 0.3s ease-out backwards;
    }
    
    tbody tr:nth-child(1) { animation-delay: 0.05s; }
    tbody tr:nth-child(2) { animation-delay: 0.1s; }
    tbody tr:nth-child(3) { animation-delay: 0.15s; }
    tbody tr:nth-child(4) { animation-delay: 0.2s; }
    tbody tr:nth-child(5) { animation-delay: 0.25s; }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    tbody tr:hover {
      background: linear-gradient(90deg, #f8f9fa 0%, #e9ecef 100%);
      transform: scale(1.01);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      display: inline-block;
    }
    
    .status-pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .status-approved {
      background: #d4edda;
      color: #155724;
    }
    
    .status-rejected {
      background: #f8d7da;
      color: #721c24;
    }
    
    .action-buttons {
      display: flex;
      gap: 5px;
    }
    
    .action-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .action-btn:hover {
      transform: scale(1.1);
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .pagination-info {
      color: var(--text-light);
      font-size: 14px;
    }
    
    .pagination-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .pagination-controls button {
      padding: 8px 15px;
      border: 2px solid var(--primary-color);
      background: white;
      color: var(--primary-color);
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .pagination-controls button:hover:not(:disabled) {
      background: var(--primary-color);
      color: white;
    }
    
    .pagination-controls button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination-controls select {
      padding: 8px;
      border: 2px solid var(--border-color);
      border-radius: 6px;
    }
    
    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-content {
      background: white;
      border-radius: 15px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      animation: slideIn 0.3s;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-header {
      padding: 25px;
      border-bottom: 2px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      color: var(--primary-color);
      font-size: 20px;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: var(--text-light);
      line-height: 1;
    }
    
    .close-btn:hover {
      color: var(--danger-color);
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-footer {
      padding: 20px 25px;
      border-top: 2px solid var(--border-color);
      display: flex;
      justify-content: flex-end;
      gap: 15px;
    }
    
    /* Loading Spinner */
    .loading {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 9999;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    
    .loading.active {
      display: flex;
    }
    
    .spinner {
      width: 80px;
      height: 80px;
      position: relative;
    }
    
    .spinner::before,
    .spinner::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      border: 4px solid transparent;
      border-top-color: var(--primary-color);
      animation: spin 1s cubic-bezier(0.5, 0, 0.5, 1) infinite;
    }
    
    .spinner::before {
      width: 100%;
      height: 100%;
    }
    
    .spinner::after {
      width: 60px;
      height: 60px;
      top: 10px;
      left: 10px;
      border-top-color: white;
      animation-duration: 0.7s;
      animation-direction: reverse;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: 30px;
      right: 30px;
      min-width: 300px;
      padding: 20px;
      border-radius: 10px;
      color: white;
      font-weight: 500;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      transform: translateX(400px);
      transition: transform 0.3s;
      z-index: 10000;
    }
    
    .toast.show {
      transform: translateX(0);
    }
    
    .toast.success {
      background: var(--success-color);
    }
    
    .toast.error {
      background: var(--danger-color);
    }
    
    .toast.info {
      background: var(--info-color);
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }
      
      .stats-container {
        grid-template-columns: 1fr;
      }
      
      .charts-container {
        grid-template-columns: 1fr;
      }
      
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .filters {
        flex-direction: column;
      }
      
      .table-wrapper {
        font-size: 12px;
      }
      
      th, td {
        padding: 8px;
      }
    }
    
    /* Utility Classes */
    .hidden {
      display: none !important;
    }
    
    .text-center {
      text-align: center;
    }
    
    .mb-20 {
      margin-bottom: 20px;
    }
    
    .mt-20 {
      margin-top: 20px;
    }
    /* ACTION BUTTONS - IMPROVED DESIGN WITH SVG ICONS */
.action-buttons {
  display: flex;
  gap: 6px;
  flex-wrap: wrap;
}

.action-btn {
  width: 36px;
  height: 36px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.action-btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transform: translate(-50%, -50%);
  transition: width 0.4s, height 0.4s;
}

.action-btn:hover::before {
  width: 80px;
  height: 80px;
}

.action-btn:hover {
  transform: translateY(-3px) scale(1.1);
  box-shadow: 0 6px 16px rgba(0,0,0,0.25);
}

.action-btn:active {
  transform: translateY(-1px) scale(1.05);
}

.action-btn svg {
  width: 18px;
  height: 18px;
  filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
  position: relative;
  z-index: 1;
}

/* Specific button styles */
.action-btn-view {
  background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
  color: white;
}

.action-btn-view:hover {
  box-shadow: 0 6px 16px rgba(33,150,243,0.4);
}

.action-btn-approve {
  background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
  color: white;
}

.action-btn-approve:hover {
  box-shadow: 0 6px 16px rgba(76,175,80,0.4);
}

.action-btn-reject {
  background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
  color: white;
}

.action-btn-reject:hover {
  box-shadow: 0 6px 16px rgba(244,67,54,0.4);
}

.action-btn-edit {
  background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
  color: white;
}

.action-btn-edit:hover {
  box-shadow: 0 6px 16px rgba(255,152,0,0.4);
}

.action-btn-print {
  background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
  color: white;
}

.action-btn-print:hover {
  box-shadow: 0 6px 16px rgba(156,39,176,0.4);
}

.action-btn-delete {
  background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
  color: white;
}

.action-btn-delete:hover {
  box-shadow: 0 6px 16px rgba(233,30,99,0.4);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .action-btn {
    width: 32px;
    height: 32px;
  }
  
  .action-btn svg {
    width: 16px;
    height: 16px;
  }
}
  </style>
</head>
<body>
  <!-- Loading Spinner -->
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div style="color: white; margin-top: 20px; font-size: 16px; font-weight: 500;" id="loadingText">ƒêang t·∫£i d·ªØ li·ªáu...</div>
  </div>
  
  <!-- Toast Notification -->
  <div id="toast" class="toast"></div>
  
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>
        <div class="logo" onclick="document.getElementById('logoInput').click()">
          <img id="logoImage" src="" alt="Logo">
          <div class="logo-upload-btn">ƒê·ªïi logo</div>
        </div>
        <input type="file" id="logoInput" accept="image/*" onchange="changeLogo(event)">
        H·ªá th·ªëng Qu·∫£n l√Ω C√¥ng t√°c
      </h1>
      <div class="user-info">
        <div>
          <div id="userName" style="font-weight: 600;">Loading...</div>
          <div id="userRole" style="font-size: 12px; opacity: 0.8;">...</div>
        </div>
        <div class="user-avatar" id="userAvatar">?</div>
      </div>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-container">
      <div class="stat-card">
        <div class="icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="#00682B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M14 2V8H20" stroke="#00682B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 13H8" stroke="#00682B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M16 17H8" stroke="#00682B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M10 9H9H8" stroke="#00682B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h3>T·ªïng s·ªë ƒëƒÉng k√Ω</h3>
        <div class="number" id="statTotal">0</div>
      </div>
      <div class="stat-card">
        <div class="icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="4" width="18" height="18" rx="2" stroke="#00682B" stroke-width="2"/>
            <path d="M16 2V6" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 2V6" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M3 10H21" stroke="#00682B" stroke-width="2"/>
            <path d="M8 14H8.01" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 14H12.01" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M16 14H16.01" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M8 18H8.01" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 18H12.01" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h3>ƒêƒÉng k√Ω th√°ng n√†y</h3>
        <div class="number" id="statMonth">0</div>
      </div>
      <div class="stat-card">
        <div class="icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="#ff9800" stroke-width="2"/>
            <path d="M12 6V12L16 14" stroke="#ff9800" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </div>
        <h3>Ch·ªù duy·ªát</h3>
        <div class="number" id="statPending">0</div>
      </div>
      <div class="stat-card">
        <div class="icon">
          <svg width="40" height="40" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.7088 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.76489 14.1003 1.98232 16.07 2.86" stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M22 4L12 14.01L9 11.01" stroke="#4caf50" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <h3>ƒê√£ duy·ªát</h3>
        <div class="number" id="statApproved">0</div>
      </div>
    </div>
    
    <!-- Charts -->
    <div class="charts-container">
      <div class="chart-card">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;">
            <path d="M18 20V10" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M12 20V4" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 20V14" stroke="#00682B" stroke-width="2" stroke-linecap="round"/>
          </svg>
          Bi·ªÉu ƒë·ªì theo th·ªùi gian
        </h3>
        <canvas id="timeChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 8px;">
            <circle cx="12" cy="12" r="10" stroke="#00682B" stroke-width="2"/>
            <path d="M12 2C12 2 15 6 15 12C15 18 12 22 12 22" stroke="#00682B" stroke-width="2"/>
            <path d="M2 12H22" stroke="#00682B" stroke-width="2"/>
          </svg>
          Bi·ªÉu ƒë·ªì theo ƒë·ªãa ƒëi·ªÉm
        </h3>
        <canvas id="locationChart"></canvas>
      </div>
    </div>
    
    <!-- Form Section -->
    <div class="form-section">
      <div class="form-header" onclick="toggleForm()">
        <h2>üìù ƒêƒÉng k√Ω c√¥ng t√°c m·ªõi</h2>
        <span class="toggle-icon" id="toggleIcon">‚ñº</span>
      </div>
      <div class="form-content" id="formContent">
        <form id="dangKyForm">
          <div class="form-grid">
            <div class="form-group">
              <label>H·ªç t√™n *</label>
              <input type="text" id="hoTen" required>
            </div>
            <div class="form-group">
              <label>Ch·ª©c v·ª• *</label>
              <select id="chucVu" required></select>
            </div>
            <div class="form-group">
              <label>Ph√≤ng ban *</label>
              <select id="phongBan" required></select>
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="email" required>
            </div>
            <div class="form-group">
              <label>Ng√†y ƒë·∫øn *</label>
              <input type="date" id="ngayDen" required>
            </div>
            <div class="form-group">
              <label>Ng√†y ƒëi *</label>
              <input type="date" id="ngayDi" required>
            </div>
            <div class="form-group">
              <label>Ph∆∞∆°ng ti·ªán *</label>
              <select id="phuongTien" required></select>
            </div>
            <div class="form-group">
              <label>ƒê·ªãa ƒëi·ªÉm c√¥ng t√°c *</label>
              <select id="diaDiem" required></select>
            </div>
          </div>
          
          <div class="form-group">
            <label>Nh√† ƒÉn</label>
            <div class="checkbox-group" id="nhaAnGroup"></div>
          </div>
          
          <div class="form-group">
            <label>Th√¥ng tin c·∫ßn thi·∫øt</label>
            <textarea id="thongTin" placeholder="Nh·∫≠p th√¥ng tin b·ªï sung..."></textarea>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn btn-secondary" onclick="resetForm()">H·ªßy</button>
            <button type="submit" class="btn btn-primary">
              <span>üì§</span> ƒêƒÉng k√Ω ngay
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Table Section -->
    <div class="table-section">
      <div class="table-header">
        <h2>üìã Danh s√°ch ƒëƒÉng k√Ω c√¥ng t√°c</h2>
        <div class="table-actions">
          <button class="btn btn-info btn-sm" onclick="exportExcel()">
            <span>üì•</span> Export Excel
          </button>
          <button class="btn btn-success btn-sm" onclick="printMultiplePDF()">
            <span>üñ®Ô∏è</span> In nhi·ªÅu PDF
          </button>
          <button class="btn btn-primary btn-sm" onclick="refreshData()">
            <span>üîÑ</span> L√†m m·ªõi
          </button>
        </div>
      </div>
      
      <!-- Filters -->
      <div class="filters">
        <div class="filter-item">
          <input type="text" id="searchInput" placeholder="üîç T√¨m ki·∫øm..." onkeyup="applyFilters()">
        </div>
        <div class="filter-item">
          <select id="filterTrangThai" onchange="applyFilters()">
            <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
          </select>
        </div>
        <div class="filter-item">
          <select id="filterDiaDiem" onchange="applyFilters()">
            <option value="">T·∫•t c·∫£ ƒë·ªãa ƒëi·ªÉm</option>
          </select>
        </div>
        <div class="filter-item">
          <input type="date" id="filterFromDate" onchange="applyFilters()">
        </div>
        <div class="filter-item">
          <input type="date" id="filterToDate" onchange="applyFilters()">
        </div>
      </div>
      
      <!-- Table -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>M√£ ƒêK</th>
              <th>H·ªç t√™n</th>
              <th>Ch·ª©c v·ª•</th>
              <th>ƒê·ªãa ƒëi·ªÉm</th>
              <th>Ng√†y ƒë·∫øn</th>
              <th>Ng√†y ƒëi</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Thao t√°c</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr>
              <td colspan="8" class="text-center">ƒêang t·∫£i d·ªØ li·ªáu...</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <!-- Pagination -->
      <div class="pagination">
        <div class="pagination-info" id="paginationInfo">Hi·ªÉn th·ªã 0 - 0 c·ªßa 0 k·∫øt qu·∫£</div>
        <div class="pagination-controls">
          <button onclick="previousPage()" id="prevBtn">‚Üê Tr∆∞·ªõc</button>
          <select id="pageSize" onchange="changePageSize()">
            <option value="10">10 d√≤ng</option>
            <option value="20" selected>20 d√≤ng</option>
            <option value="50">50 d√≤ng</option>
            <option value="100">100 d√≤ng</option>
          </select>
          <button onclick="nextPage()" id="nextBtn">Sau ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Modal: View Detail -->
  <div id="modalDetail" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üëÅÔ∏è Chi ti·∫øt ƒëƒÉng k√Ω</h3>
        <button class="close-btn" onclick="closeModal('modalDetail')">&times;</button>
      </div>
      <div class="modal-body" id="detailContent">
        <!-- Content will be populated by JS -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('modalDetail')">ƒê√≥ng</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Edit -->
  <div id="modalEdit" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úèÔ∏è Ch·ªânh s·ª≠a ƒëƒÉng k√Ω</h3>
        <button class="close-btn" onclick="closeModal('modalEdit')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="editForm">
          <input type="hidden" id="editRowIndex">
          <div class="form-grid">
            <div class="form-group">
              <label>H·ªç t√™n *</label>
              <input type="text" id="editHoTen" required>
            </div>
            <div class="form-group">
              <label>Ch·ª©c v·ª• *</label>
              <select id="editChucVu" required></select>
            </div>
            <div class="form-group">
              <label>Ph√≤ng ban *</label>
              <select id="editPhongBan" required></select>
            </div>
            <div class="form-group">
              <label>Email *</label>
              <input type="email" id="editEmail" required>
            </div>
            <div class="form-group">
              <label>Ng√†y ƒë·∫øn *</label>
              <input type="date" id="editNgayDen" required>
            </div>
            <div class="form-group">
              <label>Ng√†y ƒëi *</label>
              <input type="date" id="editNgayDi" required>
            </div>
            <div class="form-group">
              <label>Ph∆∞∆°ng ti·ªán *</label>
              <select id="editPhuongTien" required></select>
            </div>
            <div class="form-group">
              <label>ƒê·ªãa ƒëi·ªÉm *</label>
              <select id="editDiaDiem" required></select>
            </div>
          </div>
          <div class="form-group">
            <label>Nh√† ƒÉn</label>
            <div class="checkbox-group" id="editNhaAnGroup"></div>
          </div>
          <div class="form-group">
            <label>Th√¥ng tin c·∫ßn thi·∫øt</label>
            <textarea id="editThongTin"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('modalEdit')">H·ªßy</button>
        <button class="btn btn-primary" onclick="submitEdit()">üíæ L∆∞u thay ƒë·ªïi</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Approve -->
  <div id="modalApprove" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚úÖ Duy·ªát ƒëƒÉng k√Ω</h3>
        <button class="close-btn" onclick="closeModal('modalApprove')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="approveRowIndex">
        <div id="approveInfo" class="mb-20"></div>
        <div class="form-group">
          <label>Ghi ch√∫ (t√πy ch·ªçn)</label>
          <textarea id="approveNote" placeholder="Nh·∫≠p ghi ch√∫ n·∫øu c·∫ßn..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('modalApprove')">H·ªßy</button>
        <button class="btn btn-success" onclick="confirmApprove()">‚úÖ X√°c nh·∫≠n duy·ªát</button>
      </div>
    </div>
  </div>
  
  <!-- Modal: Reject -->
  <div id="modalReject" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>‚ùå T·ª´ ch·ªëi ƒëƒÉng k√Ω</h3>
        <button class="close-btn" onclick="closeModal('modalReject')">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="rejectRowIndex">
        <div id="rejectInfo" class="mb-20"></div>
        <div class="form-group">
          <label>L√Ω do t·ª´ ch·ªëi *</label>
          <textarea id="rejectReason" placeholder="Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi..." required></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('modalReject')">H·ªßy</button>
        <button class="btn btn-danger" onclick="confirmReject()">‚ùå X√°c nh·∫≠n t·ª´ ch·ªëi</button>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let allData = [];
    let filteredData = [];
    let currentPage = 1;
    let pageSize = 20;
    let userInfo = {};
    let danhMuc = {};
    let timeChart, locationChart;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      init();
    });
    
    async function init() {
      showLoading();
      updateLoadingText('ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi d√πng...');
      
      try {
        // Phase 1: Load user info tr∆∞·ªõc (b·∫Øt bu·ªôc cho ph√¢n quy·ªÅn)
        await loadUserInfo();
        updateLoadingText('ƒêang t·∫£i danh m·ª•c v√† d·ªØ li·ªáu...');
        
        // Phase 2: Load song song c√°c th√†nh ph·∫ßn kh√°c
        const [danhMucResult, dataResult, statsResult] = await Promise.allSettled([
          loadDanhMuc(),
          loadData(),
          loadStatistics()
        ]);
        
        // Ki·ªÉm tra k·∫øt qu·∫£
        if (danhMucResult.status === 'rejected') {
          console.error('L·ªói load danh m·ª•c:', danhMucResult.reason);
        }
        if (dataResult.status === 'rejected') {
          console.error('L·ªói load d·ªØ li·ªáu:', dataResult.reason);
        }
        if (statsResult.status === 'rejected') {
          console.error('L·ªói load th·ªëng k√™:', statsResult.reason);
        }
        
        updateLoadingText('ƒêang kh·ªüi t·∫°o bi·ªÉu ƒë·ªì...');
        
        // Phase 3: Setup charts sau khi c√≥ d·ªØ li·ªáu
        // Delay nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ render
        setTimeout(() => {
          setupCharts();
          updateLoadingText('Ho√†n t·∫•t!');
        }, 100);
        
      } catch (error) {
        console.error('L·ªói kh·ªüi t·∫°o:', error);
        showToast('L·ªói kh·ªüi t·∫°o: ' + error.message, 'error');
      } finally {
        setTimeout(() => {
          hideLoading();
        }, 300);
      }
    }
    
    function updateLoadingText(text) {
      const loadingText = document.getElementById('loadingText');
      if (loadingText) {
        loadingText.textContent = text;
      }
    }
    
    // API Calls
    function loadUserInfo() {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              userInfo = result.data;
              document.getElementById('userName').textContent = userInfo.email.split('@')[0];
              document.getElementById('userRole').textContent = getRoleText(userInfo.role);
              document.getElementById('userAvatar').textContent = userInfo.email.charAt(0).toUpperCase();
              
              // √Åp d·ª•ng ph√¢n quy·ªÅn UI
              applyPermissions();
              
              resolve();
            } else {
              reject(new Error(result.error));
            }
          })
          .withFailureHandler(reject)
          .getUserInfo();
      });
    }
    
    function loadDanhMuc() {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              danhMuc = result.data;
              populateDropdowns();
              resolve();
            } else {
              reject(new Error(result.error));
            }
          })
          .withFailureHandler(reject)
          .getDanhMuc();
      });
    }
    
    function loadData() {
      return new Promise((resolve, reject) => {
        const filters = getFilters();
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              allData = result.data;
              filteredData = allData;
              renderTable();
              resolve();
            } else {
              reject(new Error(result.error));
            }
          })
          .withFailureHandler(reject)
          .getDangKyList(filters);
      });
    }
    
    function loadStatistics() {
      return new Promise((resolve, reject) => {
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              updateStatistics(result.data);
              // Check data tr∆∞·ªõc khi update charts
              if (result.data && result.data.theoDiaDiem) {
                updateCharts(result.data);
              } else {
                console.log('No chart data available yet');
                setupEmptyCharts();
              }
              resolve();
            } else {
              console.error('Error loading statistics:', result.error);
              setupEmptyCharts();
              resolve(); // Don't reject, just continue
            }
          })
          .withFailureHandler(function(error) {
            console.error('Failed to load statistics:', error);
            setupEmptyCharts();
            resolve(); // Don't reject
          })
          .getThongKe();
      });
    }
    
    // Populate dropdowns
    function populateDropdowns() {
      // Ch·ª©c v·ª•
      populateSelect('chucVu', danhMuc.chucVu);
      populateSelect('editChucVu', danhMuc.chucVu);
      
      // Ph√≤ng ban
      populateSelect('phongBan', danhMuc.phongBan);
      populateSelect('editPhongBan', danhMuc.phongBan);
      
      // Ph∆∞∆°ng ti·ªán
      populateSelect('phuongTien', danhMuc.phuongTien);
      populateSelect('editPhuongTien', danhMuc.phuongTien);
      
      // ƒê·ªãa ƒëi·ªÉm
      populateSelect('diaDiem', danhMuc.diaDiem);
      populateSelect('editDiaDiem', danhMuc.diaDiem);
      populateSelect('filterDiaDiem', danhMuc.diaDiem);
      
      // Tr·∫°ng th√°i filter
      populateSelect('filterTrangThai', danhMuc.trangThai);
      
      // Nh√† ƒÉn checkboxes
      populateCheckboxGroup('nhaAnGroup', danhMuc.nhaAn);
      populateCheckboxGroup('editNhaAnGroup', danhMuc.nhaAn);
    }
    
    function populateSelect(id, options) {
      const select = document.getElementById(id);
      if (!select) return;
      
      // Keep first option if it exists
      const firstOption = select.options[0];
      select.innerHTML = '';
      if (firstOption) {
        select.appendChild(firstOption);
      }
      
      options.forEach(option => {
        const opt = document.createElement('option');
        opt.value = option;
        opt.textContent = option;
        select.appendChild(opt);
      });
    }
    
    function populateCheckboxGroup(containerId, options) {
      const container = document.getElementById(containerId);
      if (!container) return;
      
      container.innerHTML = '';
      options.forEach(option => {
        const div = document.createElement('div');
        div.className = 'checkbox-item';
        div.innerHTML = `
          <input type="checkbox" value="${option}" id="${containerId}_${option}">
          <label for="${containerId}_${option}">${option}</label>
        `;
        container.appendChild(div);
      });
    }
    
    // Form handling
    document.getElementById('dangKyForm').addEventListener('submit', function(e) {
      e.preventDefault();
      submitForm();
    });
    
    function submitForm() {
      const formData = {
        hoTen: document.getElementById('hoTen').value,
        chucVu: document.getElementById('chucVu').value,
        phongBan: document.getElementById('phongBan').value,
        email: document.getElementById('email').value,
        ngayDen: document.getElementById('ngayDen').value,
        ngayDi: document.getElementById('ngayDi').value,
        phuongTien: document.getElementById('phuongTien').value,
        diaDiem: document.getElementById('diaDiem').value,
        nhaAn: getCheckboxValues('nhaAnGroup'),
        thongTin: document.getElementById('thongTin').value
      };
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showToast(result.message, 'success');
            resetForm();
            refreshData();
          } else {
            showToast(result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToast('L·ªói: ' + error.message, 'error');
        })
        .submitDangKy(formData);
    }
    
    function getCheckboxValues(containerId) {
      const container = document.getElementById(containerId);
      const checkboxes = container.querySelectorAll('input[type="checkbox"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }
    
    function resetForm() {
      document.getElementById('dangKyForm').reset();
      // Uncheck all checkboxes
      document.querySelectorAll('#nhaAnGroup input[type="checkbox"]').forEach(cb => cb.checked = false);
    }
    
    // Table rendering
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      
      if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
        updatePagination();
        return;
      }
      
      const start = (currentPage - 1) * pageSize;
      const end = start + pageSize;
      const pageData = filteredData.slice(start, end);
      
      tbody.innerHTML = pageData.map(row => `
        <tr>
          <td><strong>${row.maDangKy}</strong></td>
          <td>${row.hoTen}</td>
          <td>${row.chucVu}</td>
          <td>${row.diaDiem}</td>
          <td>${row.ngayDen}</td>
          <td>${row.ngayDi}</td>
          <td>${getStatusBadge(row.trangThai)}</td>
          <td>
            <div class="action-buttons">
              ${getActionButtons(row)}
            </div>
          </td>
        </tr>
      `).join('');
      
      updatePagination();
    }
    
    function getStatusBadge(status) {
      const statusMap = {
        'Ch·ªù duy·ªát': { class: 'status-pending', icon: '‚è≥' },
        'ƒê√£ duy·ªát': { class: 'status-approved', icon: '‚úÖ' },
        'T·ª´ ch·ªëi': { class: 'status-rejected', icon: '‚ùå' }
      };
      const s = statusMap[status] || statusMap['Ch·ªù duy·ªát'];
      return `<span class="status-badge ${s.class}">${s.icon} ${status}</span>`;
    }
// FUNCTION getActionButtons v·ªõi SVG ICONS chuy√™n nghi·ªáp

function getActionButtons(row) {
  let buttons = '';
  
  // SVG Icons definitions
  const icons = {
    view: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M2 12C2 12 5 5 12 5C19 5 22 12 22 12C22 12 19 19 12 19C5 19 2 12 2 12Z" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2.5"/>
          </svg>`,
    approve: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
               <path d="M20 6L9 17L4 12" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
             </svg>`,
    reject: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
            </svg>`,
    edit: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M11 4H4C3.46957 4 2.96086 4.21071 2.58579 4.58579C2.21071 4.96086 2 5.46957 2 6V20C2 20.5304 2.21071 21.0391 2.58579 21.4142C2.96086 21.7893 3.46957 22 4 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M18.5 2.5C18.8978 2.10217 19.4374 1.87868 20 1.87868C20.5626 1.87868 21.1022 2.10217 21.5 2.5C21.8978 2.89782 22.1213 3.43739 22.1213 4C22.1213 4.56261 21.8978 5.10217 21.5 5.5L12 15L8 16L9 12L18.5 2.5Z" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>`,
    print: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
             <path d="M6 9V2H18V9" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
             <path d="M6 18H4C3.46957 18 2.96086 17.7893 2.58579 17.4142C2.21071 17.0391 2 16.5304 2 16V11C2 10.4696 2.21071 9.96086 2.58579 9.58579C2.96086 9.21071 3.46957 9 4 9H20C20.5304 9 21.0391 9.21071 21.4142 9.58579C21.7893 9.96086 22 10.4696 22 11V16C22 16.5304 21.7893 17.0391 21.4142 17.4142C21.0391 17.7893 20.5304 18 20 18H18" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
             <path d="M18 14H6V22H18V14Z" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
           </svg>`,
    delete: `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M3 6H5H21" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 6V4C8 3.46957 8.21071 2.96086 8.58579 2.58579C8.96086 2.21071 9.46957 2 10 2H14C14.5304 2 15.0391 2.21071 15.4142 2.58579C15.7893 2.96086 16 3.46957 16 4V6M19 6V20C19 20.5304 18.7893 21.0391 18.4142 21.4142C18.0391 21.7893 17.5304 22 17 22H7C6.46957 22 5.96086 21.7893 5.58579 21.4142C5.21071 21.0391 5 20.5304 5 20V6H19Z" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>`
  };
  
  // View button - everyone can view
  buttons += `<button class="action-btn action-btn-view" onclick="viewDetail(${row.rowIndex})" title="Xem chi ti·∫øt">${icons.view}</button>`;
  
  // Approve/Reject buttons - ch·ªâ cho Approver/Admin v√† ph·∫£i qu·∫£n l√Ω ƒë·ªãa ƒëi·ªÉm ƒë√≥
  if (row.trangThai === 'Ch·ªù duy·ªát') {
    if (userInfo.role === 'Admin') {
      // Admin c√≥ quy·ªÅn duy·ªát t·∫•t c·∫£
      buttons += `<button class="action-btn action-btn-approve" onclick="openApproveModal(${row.rowIndex}, '${row.maDangKy}')" title="Duy·ªát">${icons.approve}</button>`;
      buttons += `<button class="action-btn action-btn-reject" onclick="openRejectModal(${row.rowIndex}, '${row.maDangKy}')" title="T·ª´ ch·ªëi">${icons.reject}</button>`;
    } else if (userInfo.role === 'Approver') {
      // Approver ch·ªâ duy·ªát ƒë∆∞·ª£c ƒë·ªãa ƒëi·ªÉm m√¨nh qu·∫£n l√Ω
      const canApprove = userInfo.managedLocations.includes('T·∫•t c·∫£') || 
                        userInfo.managedLocations.includes(row.diaDiem);
      if (canApprove) {
        buttons += `<button class="action-btn action-btn-approve" onclick="openApproveModal(${row.rowIndex}, '${row.maDangKy}')" title="Duy·ªát">${icons.approve}</button>`;
        buttons += `<button class="action-btn action-btn-reject" onclick="openRejectModal(${row.rowIndex}, '${row.maDangKy}')" title="T·ª´ ch·ªëi">${icons.reject}</button>`;
      }
    }
  }
  
  // Edit button - ch·ªâ cho ch·ªß s·ªü h·ªØu khi status l√† pending ho·∫∑c Admin
  if (row.trangThai === 'Ch·ªù duy·ªát' && (userInfo.role === 'Admin' || row.email === userInfo.email)) {
    buttons += `<button class="action-btn action-btn-edit" onclick="openEditModal(${row.rowIndex})" title="S·ª≠a">${icons.edit}</button>`;
  }
  
  // Print PDF button - ai c≈©ng c√≥ th·ªÉ in
  buttons += `<button class="action-btn action-btn-print" onclick="printPDF(${row.rowIndex})" title="In PDF">${icons.print}</button>`;
  
  // Delete button - ch·ªâ cho ch·ªß s·ªü h·ªØu khi pending ho·∫∑c Admin
  if (row.trangThai === 'Ch·ªù duy·ªát' && (userInfo.role === 'Admin' || row.email === userInfo.email)) {
    buttons += `<button class="action-btn action-btn-delete" onclick="deleteRecord(${row.rowIndex}, '${row.maDangKy}')" title="X√≥a">${icons.delete}</button>`;
  }
  
  return buttons;
}
    
    // CRUD Operations
    function viewDetail(rowIndex) {
      const row = allData.find(r => r.rowIndex === rowIndex);
      if (!row) return;
      
      const content = `
        <table class="info-table" style="width: 100%; border-collapse: collapse;">
          <tr><td style="padding: 10px; font-weight: 600; width: 40%;">M√£ ƒëƒÉng k√Ω:</td><td style="padding: 10px;">${row.maDangKy}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Th·ªùi gian ƒëƒÉng k√Ω:</td><td style="padding: 10px;">${row.timestamp}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">H·ªç t√™n:</td><td style="padding: 10px;"><strong>${row.hoTen}</strong></td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Ch·ª©c v·ª•:</td><td style="padding: 10px;">${row.chucVu}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Ph√≤ng ban:</td><td style="padding: 10px;">${row.phongBan}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Email:</td><td style="padding: 10px;">${row.email}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Ng√†y ƒë·∫øn:</td><td style="padding: 10px;">${row.ngayDen}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Ng√†y ƒëi:</td><td style="padding: 10px;">${row.ngayDi}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Ph∆∞∆°ng ti·ªán:</td><td style="padding: 10px;">${row.phuongTien}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Nh√† ƒÉn:</td><td style="padding: 10px;">${row.nhaAn || 'Kh√¥ng'}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">ƒê·ªãa ƒëi·ªÉm:</td><td style="padding: 10px;"><strong>${row.diaDiem}</strong></td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Th√¥ng tin:</td><td style="padding: 10px;">${row.thongTin || 'Kh√¥ng c√≥'}</td></tr>
          <tr><td style="padding: 10px; font-weight: 600;">Tr·∫°ng th√°i:</td><td style="padding: 10px;">${getStatusBadge(row.trangThai)}</td></tr>
          ${row.nguoiDuyet ? `<tr><td style="padding: 10px; font-weight: 600;">Ng∆∞·ªùi duy·ªát:</td><td style="padding: 10px;">${row.nguoiDuyet}</td></tr>` : ''}
          ${row.ngayDuyet ? `<tr><td style="padding: 10px; font-weight: 600;">Ng√†y duy·ªát:</td><td style="padding: 10px;">${row.ngayDuyet}</td></tr>` : ''}
          ${row.lyDoTuChoi ? `<tr><td style="padding: 10px; font-weight: 600;">L√Ω do t·ª´ ch·ªëi:</td><td style="padding: 10px; color: #f44336;">${row.lyDoTuChoi}</td></tr>` : ''}
        </table>
      `;
      
      document.getElementById('detailContent').innerHTML = content;
      openModal('modalDetail');
    }
    
    function openEditModal(rowIndex) {
      const row = allData.find(r => r.rowIndex === rowIndex);
      if (!row) return;
      
      // Ki·ªÉm tra quy·ªÅn s·ª≠a
      if (row.trangThai !== 'Ch·ªù duy·ªát') {
        showToast('Ch·ªâ c√≥ th·ªÉ s·ª≠a ƒëƒÉng k√Ω ƒëang ch·ªù duy·ªát', 'error');
        return;
      }
      
      if (userInfo.role !== 'Admin' && row.email !== userInfo.email) {
        showToast('B·∫°n ch·ªâ c√≥ th·ªÉ s·ª≠a ƒëƒÉng k√Ω c·ªßa m√¨nh', 'error');
        return;
      }
      
      document.getElementById('editRowIndex').value = rowIndex;
      document.getElementById('editHoTen').value = row.hoTen;
      document.getElementById('editChucVu').value = row.chucVu;
      document.getElementById('editPhongBan').value = row.phongBan;
      document.getElementById('editEmail').value = row.email;
      document.getElementById('editNgayDen').value = convertDateFormat(row.ngayDen);
      document.getElementById('editNgayDi').value = convertDateFormat(row.ngayDi);
      document.getElementById('editPhuongTien').value = row.phuongTien;
      document.getElementById('editDiaDiem').value = row.diaDiem;
      document.getElementById('editThongTin').value = row.thongTin || '';
      
      // Set checkboxes
      const nhaAnArray = row.nhaAn ? row.nhaAn.split(', ') : [];
      document.querySelectorAll('#editNhaAnGroup input[type="checkbox"]').forEach(cb => {
        cb.checked = nhaAnArray.includes(cb.value);
      });
      
      openModal('modalEdit');
    }
    
    function submitEdit() {
      const rowIndex = parseInt(document.getElementById('editRowIndex').value);
      const formData = {
        hoTen: document.getElementById('editHoTen').value,
        chucVu: document.getElementById('editChucVu').value,
        phongBan: document.getElementById('editPhongBan').value,
        email: document.getElementById('editEmail').value,
        ngayDen: document.getElementById('editNgayDen').value,
        ngayDi: document.getElementById('editNgayDi').value,
        phuongTien: document.getElementById('editPhuongTien').value,
        diaDiem: document.getElementById('editDiaDiem').value,
        nhaAn: getCheckboxValues('editNhaAnGroup'),
        thongTin: document.getElementById('editThongTin').value
      };
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showToast(result.message, 'success');
            closeModal('modalEdit');
            refreshData();
          } else {
            showToast(result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToast('L·ªói: ' + error.message, 'error');
        })
        .updateDangKy(rowIndex, formData);
    }
    
    function deleteRecord(rowIndex, maDangKy) {
      const row = allData.find(r => r.rowIndex === rowIndex);
      if (!row) return;
      
      // Ki·ªÉm tra quy·ªÅn x√≥a
      if (row.trangThai !== 'Ch·ªù duy·ªát') {
        showToast('Ch·ªâ c√≥ th·ªÉ x√≥a ƒëƒÉng k√Ω ƒëang ch·ªù duy·ªát', 'error');
        return;
      }
      
      if (userInfo.role !== 'Admin' && row.email !== userInfo.email) {
        showToast('B·∫°n ch·ªâ c√≥ th·ªÉ x√≥a ƒëƒÉng k√Ω c·ªßa m√¨nh', 'error');
        return;
      }
      
      if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ƒëƒÉng k√Ω ${maDangKy}?`)) return;
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showToast(result.message, 'success');
            refreshData();
          } else {
            showToast(result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToast('L·ªói: ' + error.message, 'error');
        })
        .deleteDangKy(rowIndex);
    }
    
    // Approve/Reject
    function openApproveModal(rowIndex, maDangKy) {
      const row = allData.find(r => r.rowIndex === rowIndex);
      if (!row) return;
      
      // Ki·ªÉm tra quy·ªÅn duy·ªát
      if (userInfo.role === 'Approver') {
        const canApprove = userInfo.managedLocations.includes('T·∫•t c·∫£') || 
                          userInfo.managedLocations.includes(row.diaDiem);
        if (!canApprove) {
          showToast(`B·∫°n kh√¥ng c√≥ quy·ªÅn duy·ªát ƒë·ªãa ƒëi·ªÉm "${row.diaDiem}"`, 'error');
          return;
        }
      } else if (userInfo.role === 'User') {
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn duy·ªát ƒëƒÉng k√Ω', 'error');
        return;
      }
      
      document.getElementById('approveRowIndex').value = rowIndex;
      document.getElementById('approveInfo').innerHTML = `
        <div style="padding: 15px; background: #f0f9f5; border-radius: 8px;">
          <p><strong>M√£ ƒëƒÉng k√Ω:</strong> ${maDangKy}</p>
          <p><strong>Ng∆∞·ªùi ƒëƒÉng k√Ω:</strong> ${row.hoTen} - ${row.chucVu}</p>
          <p><strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${row.diaDiem}</p>
          <p><strong>Th·ªùi gian:</strong> ${row.ngayDen} - ${row.ngayDi}</p>
        </div>
      `;
      openModal('modalApprove');
    }
    
    function confirmApprove() {
      const rowIndex = parseInt(document.getElementById('approveRowIndex').value);
      const note = document.getElementById('approveNote').value;
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showToast(result.message, 'success');
            closeModal('modalApprove');
            document.getElementById('approveNote').value = '';
            refreshData();
          } else {
            showToast(result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToast('L·ªói: ' + error.message, 'error');
        })
        .approveDangKy(rowIndex, note);
    }
    
    function openRejectModal(rowIndex, maDangKy) {
      const row = allData.find(r => r.rowIndex === rowIndex);
      if (!row) return;
      
      // Ki·ªÉm tra quy·ªÅn t·ª´ ch·ªëi
      if (userInfo.role === 'Approver') {
        const canReject = userInfo.managedLocations.includes('T·∫•t c·∫£') || 
                         userInfo.managedLocations.includes(row.diaDiem);
        if (!canReject) {
          showToast(`B·∫°n kh√¥ng c√≥ quy·ªÅn t·ª´ ch·ªëi ƒë·ªãa ƒëi·ªÉm "${row.diaDiem}"`, 'error');
          return;
        }
      } else if (userInfo.role === 'User') {
        showToast('B·∫°n kh√¥ng c√≥ quy·ªÅn t·ª´ ch·ªëi ƒëƒÉng k√Ω', 'error');
        return;
      }
      
      document.getElementById('rejectRowIndex').value = rowIndex;
      document.getElementById('rejectInfo').innerHTML = `
        <div style="padding: 15px; background: #fff3e0; border-radius: 8px;">
          <p><strong>M√£ ƒëƒÉng k√Ω:</strong> ${maDangKy}</p>
          <p><strong>Ng∆∞·ªùi ƒëƒÉng k√Ω:</strong> ${row.hoTen} - ${row.chucVu}</p>
          <p><strong>ƒê·ªãa ƒëi·ªÉm:</strong> ${row.diaDiem}</p>
        </div>
      `;
      openModal('modalReject');
    }
    
    function confirmReject() {
      const rowIndex = parseInt(document.getElementById('rejectRowIndex').value);
      const reason = document.getElementById('rejectReason').value;
      
      if (!reason || reason.trim() === '') {
        showToast('Vui l√≤ng nh·∫≠p l√Ω do t·ª´ ch·ªëi!', 'error');
        return;
      }
      
      showLoading();
      google.script.run
        .withSuccessHandler(function(result) {
          hideLoading();
          if (result.success) {
            showToast(result.message, 'success');
            closeModal('modalReject');
            document.getElementById('rejectReason').value = '';
            refreshData();
          } else {
            showToast(result.error, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          showToast('L·ªói: ' + error.message, 'error');
        })
        .rejectDangKy(rowIndex, reason);
    }
    
    // Export Excel
    function exportExcel() {
      if (filteredData.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ export!', 'error');
        return;
      }
      
      showLoading();
      
      // Prepare data for export
      const exportData = filteredData.map(row => ({
        'M√£ ƒêK': row.maDangKy,
        'Ng√†y ƒëƒÉng k√Ω': row.timestamp,
        'H·ªç t√™n': row.hoTen,
        'Ch·ª©c v·ª•': row.chucVu,
        'Ph√≤ng ban': row.phongBan,
        'Email': row.email,
        'Ng√†y ƒë·∫øn': row.ngayDen,
        'Ng√†y ƒëi': row.ngayDi,
        'Ph∆∞∆°ng ti·ªán': row.phuongTien,
        'Nh√† ƒÉn': row.nhaAn,
        'ƒê·ªãa ƒëi·ªÉm': row.diaDiem,
        'Th√¥ng tin': row.thongTin,
        'Tr·∫°ng th√°i': row.trangThai,
        'Ng∆∞·ªùi duy·ªát': row.nguoiDuyet || '',
        'Ng√†y duy·ªát': row.ngayDuyet || '',
        'L√Ω do t·ª´ ch·ªëi': row.lyDoTuChoi || ''
      }));
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(exportData);
      
      // Style header
      const range = XLSX.utils.decode_range(ws['!ref']);
      for (let C = range.s.c; C <= range.e.c; ++C) {
        const address = XLSX.utils.encode_col(C) + '1';
        if (!ws[address]) continue;
        ws[address].s = {
          fill: { fgColor: { rgb: "00A86B" } },
          font: { bold: true, color: { rgb: "FFFFFF" } }
        };
      }
      
      // Auto-size columns
      const colWidths = [];
      for (let C = range.s.c; C <= range.e.c; ++C) {
        let maxWidth = 10;
        for (let R = range.s.r; R <= range.e.r; ++R) {
          const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
          if (cell && cell.v) {
            const cellWidth = cell.v.toString().length;
            if (cellWidth > maxWidth) maxWidth = cellWidth;
          }
        }
        colWidths.push({ wch: Math.min(maxWidth + 2, 50) });
      }
      ws['!cols'] = colWidths;
      
      XLSX.utils.book_append_sheet(wb, ws, 'Danh s√°ch c√¥ng t√°c');
      
      // Generate filename
      const now = new Date();
      const filename = `DanhSachCongTac_${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}.xlsx`;
      
      // Download
      XLSX.writeFile(wb, filename);
      
      hideLoading();
      showToast(`ƒê√£ export ${filteredData.length} d√≤ng d·ªØ li·ªáu!`, 'success');
    }
    
    // Print PDF
    function printPDF(rowIndex) {
      const row = allData.find(r => r.rowIndex === rowIndex);
      if (!row) return;
      
      showLoading();
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // IMPORTANT: Add Vietnamese font support
      // Download font from: https://github.com/bpampuch/pdfmake/tree/master/fonts
      // For now, we'll use a workaround with larger font to avoid character issues
      doc.setFont('helvetica');
      
      let y = 20;
      
      // Header with company name
      doc.setFontSize(18);
      doc.setTextColor(0, 104, 43); // THACO green
      doc.text('CONG TY THACO AGRI', 105, y, { align: 'center' });
      
      y += 10;
      doc.setFontSize(14);
      doc.text('PHIEU DANG KY CONG TAC', 105, y, { align: 'center' });
      
      y += 5;
      doc.setFontSize(10);
      doc.setTextColor(100);
      doc.text(`Ma: ${row.maDangKy}`, 105, y, { align: 'center' });
      
      // Green line separator
      y += 10;
      doc.setDrawColor(0, 104, 43);
      doc.setLineWidth(0.5);
      doc.line(20, y, 190, y);
      
      // Content section
      y += 15;
      doc.setFontSize(11);
      doc.setTextColor(0);
      
      const addField = (label, value) => {
        doc.setFont('helvetica', 'bold');
        doc.text(label + ':', 25, y);
        doc.setFont('helvetica', 'normal');
        // Convert Vietnamese characters to ASCII-safe version
        const safeValue = convertToAscii(value || '');
        doc.text(safeValue, 70, y);
        y += 8;
      };
      
      addField('Ho ten', row.hoTen);
      addField('Chuc vu', row.chucVu);
      addField('Phong ban', row.phongBan);
      addField('Email', row.email);
      
      y += 3;
      addField('Ngay den', row.ngayDen);
      addField('Ngay di', row.ngayDi);
      addField('Dia diem', row.diaDiem);
      addField('Phuong tien', row.phuongTien);
      addField('Nha an', row.nhaAn || 'Khong');
      
      if (row.thongTin) {
        y += 3;
        doc.setFont('helvetica', 'bold');
        doc.text('Thong tin:', 25, y);
        y += 6;
        doc.setFont('helvetica', 'normal');
        const safeThongTin = convertToAscii(row.thongTin);
        const lines = doc.splitTextToSize(safeThongTin, 160);
        doc.text(lines, 25, y);
        y += lines.length * 6;
      }
      
      // Status section
      y += 10;
      doc.setLineWidth(0.5);
      doc.line(20, y, 190, y);
      y += 10;
      
      doc.setFont('helvetica', 'bold');
      doc.text('Trang thai:', 25, y);
      doc.setFont('helvetica', 'normal');
      
      // Color based on status
      const statusMap = {
        'ƒê√£ duy·ªát': { color: [0, 128, 0], text: 'Da duyet' },
        'T·ª´ ch·ªëi': { color: [255, 0, 0], text: 'Tu choi' },
        'Ch·ªù duy·ªát': { color: [255, 152, 0], text: 'Cho duyet' }
      };
      
      const status = statusMap[row.trangThai] || { color: [0, 0, 0], text: row.trangThai };
      doc.setTextColor(...status.color);
      doc.text(status.text, 70, y);
      doc.setTextColor(0);
      
      if (row.nguoiDuyet) {
        y += 8;
        doc.text(`Nguoi duyet: ${convertToAscii(row.nguoiDuyet)}`, 25, y);
      }
      if (row.ngayDuyet) {
        y += 8;
        doc.text(`Ngay duyet: ${row.ngayDuyet}`, 25, y);
      }
      
      // Footer
      y = 270;
      doc.setFontSize(9);
      doc.setTextColor(150);
      doc.text('He thong quan ly cong tac - THACO AGRI', 105, y, { align: 'center' });
      const now = new Date();
      const dateStr = `${now.getDate()}/${now.getMonth()+1}/${now.getFullYear()} ${now.getHours()}:${now.getMinutes()}`;
      doc.text(`In ngay: ${dateStr}`, 105, y + 5, { align: 'center' });
      
      // Save with proper filename
      doc.save(`PhieuCongTac_${row.maDangKy}.pdf`);
      
      hideLoading();
      showToast('ƒê√£ t·∫°o file PDF!', 'success');
    }
    
    // Helper function to convert Vietnamese to ASCII
    function convertToAscii(str) {
      if (!str) return '';
      
      const vietnameseMap = {
        '√†': 'a', '√°': 'a', '·∫£': 'a', '√£': 'a', '·∫°': 'a',
        'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫≥': 'a', '·∫µ': 'a', '·∫∑': 'a',
        '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫©': 'a', '·∫´': 'a', '·∫≠': 'a',
        'ƒë': 'd',
        '√®': 'e', '√©': 'e', '·∫ª': 'e', '·∫Ω': 'e', '·∫π': 'e',
        '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªÉ': 'e', '·ªÖ': 'e', '·ªá': 'e',
        '√¨': 'i', '√≠': 'i', '·ªâ': 'i', 'ƒ©': 'i', '·ªã': 'i',
        '√≤': 'o', '√≥': 'o', '·ªè': 'o', '√µ': 'o', '·ªç': 'o',
        '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªï': 'o', '·ªó': 'o', '·ªô': 'o',
        '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ªü': 'o', '·ª°': 'o', '·ª£': 'o',
        '√π': 'u', '√∫': 'u', '·ªß': 'u', '≈©': 'u', '·ª•': 'u',
        '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª≠': 'u', '·ªØ': 'u', '·ª±': 'u',
        '·ª≥': 'y', '√Ω': 'y', '·ª∑': 'y', '·ªπ': 'y', '·ªµ': 'y',
        '√Ä': 'A', '√Å': 'A', '·∫¢': 'A', '√É': 'A', '·∫†': 'A',
        'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫≤': 'A', '·∫¥': 'A', '·∫∂': 'A',
        '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫®': 'A', '·∫™': 'A', '·∫¨': 'A',
        'ƒê': 'D',
        '√à': 'E', '√â': 'E', '·∫∫': 'E', '·∫º': 'E', '·∫∏': 'E',
        '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÇ': 'E', '·ªÑ': 'E', '·ªÜ': 'E',
        '√å': 'I', '√ç': 'I', '·ªà': 'I', 'ƒ®': 'I', '·ªä': 'I',
        '√í': 'O', '√ì': 'O', '·ªé': 'O', '√ï': 'O', '·ªå': 'O',
        '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªî': 'O', '·ªñ': 'O', '·ªò': 'O',
        '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ªû': 'O', '·ª†': 'O', '·ª¢': 'O',
        '√ô': 'U', '√ö': 'U', '·ª¶': 'U', '≈®': 'U', '·ª§': 'U',
        '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª¨': 'U', '·ªÆ': 'U', '·ª∞': 'U',
        '·ª≤': 'Y', '√ù': 'Y', '·ª∂': 'Y', '·ª∏': 'Y', '·ª¥': 'Y'
      };
      
      return str.split('').map(char => vietnameseMap[char] || char).join('');
    }
    
    function printMultiplePDF() {
      if (filteredData.length === 0) {
        showToast('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ in!', 'error');
        return;
      }
      
      if (!confirm(`B·∫°n mu·ªën in PDF cho ${filteredData.length} ƒëƒÉng k√Ω?`)) return;
      
      showLoading();
      
      // In t·ª´ng PDF
      filteredData.slice(0, 10).forEach((row, index) => {
        setTimeout(() => {
          printPDF(row.rowIndex);
        }, index * 500);
      });
      
      setTimeout(() => {
        hideLoading();
        if (filteredData.length > 10) {
          showToast(`ƒê√£ in 10 PDF ƒë·∫ßu ti√™n!`, 'info');
        }
      }, filteredData.length * 500);
    }
    
    // Filters
    function getFilters() {
      return {
        search: document.getElementById('searchInput').value,
        trangThai: document.getElementById('filterTrangThai').value,
        diaDiem: document.getElementById('filterDiaDiem').value,
        fromDate: document.getElementById('filterFromDate').value,
        toDate: document.getElementById('filterToDate').value
      };
    }
    
    function applyFilters() {
      const filters = getFilters();
      
      filteredData = allData.filter(row => {
        // Search
        if (filters.search) {
          const searchLower = filters.search.toLowerCase();
          const searchFields = [
            row.maDangKy,
            row.hoTen,
            row.email,
            row.diaDiem,
            row.phongBan
          ].map(f => (f || '').toLowerCase());
          
          if (!searchFields.some(f => f.includes(searchLower))) {
            return false;
          }
        }
        
        // Status filter
        if (filters.trangThai && row.trangThai !== filters.trangThai) {
          return false;
        }
        
        // Location filter
        if (filters.diaDiem && row.diaDiem !== filters.diaDiem) {
          return false;
        }
        
        // Date filters
        if (filters.fromDate) {
          const rowDate = convertDateFormat(row.ngayDen);
          if (rowDate < filters.fromDate) return false;
        }
        if (filters.toDate) {
          const rowDate = convertDateFormat(row.ngayDen);
          if (rowDate > filters.toDate) return false;
        }
        
        return true;
      });
      
      currentPage = 1;
      renderTable();
    }
    
    // Pagination
    function updatePagination() {
      const total = filteredData.length;
      const start = (currentPage - 1) * pageSize + 1;
      const end = Math.min(start + pageSize - 1, total);
      
      document.getElementById('paginationInfo').textContent = 
        `Hi·ªÉn th·ªã ${start} - ${end} c·ªßa ${total} k·∫øt qu·∫£`;
      
      document.getElementById('prevBtn').disabled = currentPage === 1;
      document.getElementById('nextBtn').disabled = end >= total;
    }
    
    function previousPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }
    
    function nextPage() {
      const maxPage = Math.ceil(filteredData.length / pageSize);
      if (currentPage < maxPage) {
        currentPage++;
        renderTable();
      }
    }
    
    function changePageSize() {
      pageSize = parseInt(document.getElementById('pageSize').value);
      currentPage = 1;
      renderTable();
    }
    
    // Charts
    function setupCharts() {
      // Destroy existing charts n·∫øu c√≥
      if (timeChart) {
        timeChart.destroy();
        timeChart = null;
      }
      if (locationChart) {
        locationChart.destroy();
        locationChart = null;
      }
      
      // Time chart
      const timeCtx = document.getElementById('timeChart');
      if (timeCtx) {
        timeChart = new Chart(timeCtx.getContext('2d'), {
          type: 'bar',
          data: {
            labels: [],
            datasets: [{
              label: 'S·ªë l∆∞·ª£ng ƒëƒÉng k√Ω',
              data: [],
              backgroundColor: 'rgba(0, 104, 43, 0.8)',
              borderColor: 'rgba(0, 104, 43, 1)',
              borderWidth: 2,
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            animation: {
              duration: 800,
              easing: 'easeInOutQuart'
            },
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { 
                beginAtZero: true,
                grid: {
                  color: 'rgba(0, 0, 0, 0.05)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
      
      // Location chart
      const locationCtx = document.getElementById('locationChart');
      if (locationCtx) {
        locationChart = new Chart(locationCtx.getContext('2d'), {
          type: 'doughnut',
          data: {
            labels: [],
            datasets: [{
              data: [],
              backgroundColor: [
                '#00682B',
                '#FFFBD5',
                '#ff9800',
                '#4caf50',
                '#2196f3'
              ],
              borderWidth: 2,
              borderColor: '#fff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            animation: {
              duration: 1000,
              easing: 'easeInOutQuart'
            },
            plugins: {
              legend: { 
                position: 'bottom',
                labels: {
                  padding: 15,
                  font: {
                    size: 12
                  }
                }
              }
            }
          }
        });
      }
    }
    
    function updateStatistics(stats) {
      if (!stats) {
        document.getElementById('statTotal').textContent = '0';
        document.getElementById('statMonth').textContent = '0';
        document.getElementById('statPending').textContent = '0';
        document.getElementById('statApproved').textContent = '0';
        return;
      }
      
      document.getElementById('statTotal').textContent = stats.tongSo || 0;
      document.getElementById('statMonth').textContent = stats.thangNay || 0;
      document.getElementById('statPending').textContent = stats.choDuyet || 0;
      document.getElementById('statApproved').textContent = stats.daDuyet || 0;
    }
    
    function updateCharts(stats) {
      // Safety check
      if (!stats || !stats.theoDiaDiem) {
        console.log('Invalid chart data, using empty charts');
        setupEmptyCharts();
        return;
      }
      
      if (!timeChart || !locationChart) {
        console.log('Charts not initialized');
        return;
      }
      
      try {
        // Update location chart
        const locations = Object.keys(stats.theoDiaDiem);
        const locationData = Object.values(stats.theoDiaDiem);
        
        locationChart.data.labels = locations;
        locationChart.data.datasets[0].data = locationData;
        locationChart.update();
        
        // Time chart - calculate last 6 months data
        const months = [];
        const monthData = [];
        const now = new Date();
        
        for (let i = 5; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
          months.push(`T${d.getMonth() + 1}/${d.getFullYear()}`);
          
          // Count registrations in this month
          const count = allData.filter(row => {
            if (!row.timestamp) return false;
            const rowDate = new Date(convertDateFormat(row.timestamp));
            return rowDate.getMonth() === d.getMonth() && 
                   rowDate.getFullYear() === d.getFullYear();
          }).length;
          monthData.push(count);
        }
        
        timeChart.data.labels = months;
        timeChart.data.datasets[0].data = monthData;
        timeChart.update();
      } catch (error) {
        console.error('Error updating charts:', error);
        setupEmptyCharts();
      }
    }
    
    function setupEmptyCharts() {
      if (!timeChart || !locationChart) {
        return; // Charts not initialized yet
      }
      
      // Empty time chart
      timeChart.data.labels = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6'];
      timeChart.data.datasets[0].data = [0, 0, 0, 0, 0, 0];
      timeChart.update();
      
      // Empty location chart
      locationChart.data.labels = ['VƒÉn ph√≤ng 55', 'B√¨nh Ph∆∞·ªõc 1', 'B√¨nh Ph∆∞·ªõc 2', 'ERC', 'Xi nghi·ªáp B√≤'];
      locationChart.data.datasets[0].data = [0, 0, 0, 0, 0];
      locationChart.update();
    }
    
    // Helpers
    function toggleForm() {
      const content = document.getElementById('formContent');
      const icon = document.getElementById('toggleIcon');
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        icon.classList.remove('rotated');
      } else {
        content.classList.add('expanded');
        icon.classList.add('rotated');
      }
    }
    
    function refreshData() {
      init();
    }
    
    function openModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }
    
    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }
    
    function showLoading() {
      document.getElementById('loading').classList.add('active');
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.remove('active');
    }
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 4000);
    }
    
    function getRoleText(role) {
      const roles = {
        'Admin': 'Qu·∫£n tr·ªã vi√™n',
        'Approver': 'Ng∆∞·ªùi duy·ªát',
        'User': 'Ng∆∞·ªùi d√πng'
      };
      return roles[role] || role;
    }
    
    // √Åp d·ª•ng ph√¢n quy·ªÅn UI
    function applyPermissions() {
      const role = userInfo.role;
      
      // User th∆∞·ªùng: ch·ªâ xem ƒë∆∞·ª£c form ƒëƒÉng k√Ω c·ªßa m√¨nh
      if (role === 'User') {
        // ·∫®n ph·∫ßn th·ªëng k√™
        const statsContainer = document.querySelector('.stats-container');
        if (statsContainer) {
          statsContainer.style.display = 'none';
        }
        
        // ·∫®n bi·ªÉu ƒë·ªì
        const chartsContainer = document.querySelector('.charts-container');
        if (chartsContainer) {
          chartsContainer.style.display = 'none';
        }
        
        // Hi·ªÉn th·ªã th√¥ng b√°o quy·ªÅn h·∫°n
        const header = document.querySelector('.header h1');
        if (header) {
          const roleNote = document.createElement('div');
          roleNote.style.fontSize = '14px';
          roleNote.style.fontWeight = 'normal';
          roleNote.style.marginTop = '5px';
          roleNote.style.opacity = '0.9';
          roleNote.textContent = '(B·∫°n ch·ªâ c√≥ th·ªÉ xem v√† qu·∫£n l√Ω c√°c ƒëƒÉng k√Ω c·ªßa m√¨nh)';
          header.appendChild(roleNote);
        }
      }
      
      // Approver: xem ƒë∆∞·ª£c th·ªëng k√™ c·ªßa ƒë·ªãa ƒëi·ªÉm m√¨nh qu·∫£n l√Ω
      if (role === 'Approver') {
        const header = document.querySelector('.header h1');
        if (header && userInfo.managedLocations) {
          const roleNote = document.createElement('div');
          roleNote.style.fontSize = '14px';
          roleNote.style.fontWeight = 'normal';
          roleNote.style.marginTop = '5px';
          roleNote.style.opacity = '0.9';
          
          if (userInfo.managedLocations.includes('T·∫•t c·∫£')) {
            roleNote.textContent = '(B·∫°n c√≥ quy·ªÅn duy·ªát t·∫•t c·∫£ c√°c ƒë·ªãa ƒëi·ªÉm)';
          } else {
            roleNote.textContent = `(B·∫°n c√≥ quy·ªÅn duy·ªát: ${userInfo.managedLocations.join(', ')})`;
          }
          header.appendChild(roleNote);
        }
      }
      
      // Admin: full quy·ªÅn
      if (role === 'Admin') {
        const header = document.querySelector('.header h1');
        if (header) {
          const roleNote = document.createElement('div');
          roleNote.style.fontSize = '14px';
          roleNote.style.fontWeight = 'normal';
          roleNote.style.marginTop = '5px';
          roleNote.style.opacity = '0.9';
          roleNote.textContent = '(B·∫°n c√≥ to√†n quy·ªÅn qu·∫£n tr·ªã h·ªá th·ªëng)';
          header.appendChild(roleNote);
        }
      }
      
      // C·∫≠p nh·∫≠t placeholder search d·ª±a tr√™n role
      const searchInput = document.getElementById('searchInput');
      if (searchInput) {
        if (role === 'User') {
          searchInput.placeholder = 'T√¨m trong c√°c ƒëƒÉng k√Ω c·ªßa b·∫°n...';
        } else if (role === 'Approver') {
          searchInput.placeholder = 'T√¨m trong c√°c ƒëƒÉng k√Ω thu·ªôc ƒë·ªãa ƒëi·ªÉm b·∫°n qu·∫£n l√Ω...';
        } else {
          searchInput.placeholder = 'T√¨m theo t√™n, email, m√£ ƒëƒÉng k√Ω...';
        }
      }
    }
    
    function convertDateFormat(dateStr) {
      if (!dateStr) return '';
      // Convert dd/MM/yyyy to yyyy-MM-dd
      const parts = dateStr.split('/');
      if (parts.length === 3) {
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      }
      return dateStr;
    }
    
    // Logo management
    function changeLogo(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.startsWith('image/')) {
        showToast('Vui l√≤ng ch·ªçn file ·∫£nh!', 'error');
        return;
      }
      
      // Validate file size (max 500KB for upload to Drive)
      if (file.size > 500 * 1024) {
        showToast('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 500KB! Vui l√≤ng n√©n ·∫£nh tr∆∞·ªõc khi upload.', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const logoImage = document.getElementById('logoImage');
        const imageData = e.target.result;
        
        // Show preview immediately
        logoImage.src = imageData;
        
        // Add animation effect
        logoImage.style.transform = 'scale(0)';
        setTimeout(() => {
          logoImage.style.transition = 'transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
          logoImage.style.transform = 'scale(1)';
        }, 100);
        
        showLoading();
        updateLoadingText('ƒêang l∆∞u logo...');
        
        // Upload to server (Google Apps Script)
        google.script.run
          .withSuccessHandler(function(result) {
            hideLoading();
            if (result.success) {
              showToast('ƒê√£ c·∫≠p nh·∫≠t logo th√†nh c√¥ng! Logo s·∫Ω hi·ªÉn th·ªã cho t·∫•t c·∫£ users.', 'success');
            } else {
              showToast('L·ªói: ' + result.error, 'error');
              // Revert to default if error
              loadCompanyLogo();
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            showToast('Kh√¥ng th·ªÉ l∆∞u logo: ' + error.message, 'error');
            // Revert to default if error
            loadCompanyLogo();
          })
          .saveCompanyLogo(imageData);
      };
      
      reader.readAsDataURL(file);
    }
    
    // Load company logo from server
    function loadCompanyLogo() {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success && result.logoUrl) {
            const logoImage = document.getElementById('logoImage');
            logoImage.src = result.logoUrl;
          }
        })
        .withFailureHandler(function(error) {
          console.error('Error loading logo:', error);
        })
        .getCompanyLogo();
    }
    
    // Load logo when page loads
    document.addEventListener('DOMContentLoaded', function() {
      loadCompanyLogo();
    });
  </script>
</body>
</html>
